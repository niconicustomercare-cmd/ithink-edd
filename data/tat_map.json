import fs from "fs";
import path from "path";

export default function handler(req, res) {
  try {
    const { pickup_pincode, to_pincode } = req.query;

    if (!pickup_pincode || !to_pincode) {
      return res.status(400).json({ error: "Missing pincodes" });
    }

    const filePath = path.join(process.cwd(), "data", "tat_map.json");
    const raw = fs.readFileSync(filePath, "utf8");
    const rows = JSON.parse(raw);

    const row = rows.find(
      r =>
        String(r.pickup_pincode) === String(pickup_pincode) &&
        String(r.to_pincode) === String(to_pincode)
    );

    if (!row) {
      return res.status(200).json({
        edd: null,
        message: "EDD not available for this pincode"
      });
    }

    // âœ… FIX: handle decimal TAT safely
    const tatRaw = Number(row.tat);
    const tatDays = Math.ceil(tatRaw);   // round UP
    const finalDays = tatDays + 1;        // +24 hrs buffer

    const edd = new Date();
    edd.setDate(edd.getDate() + finalDays);

    return res.status(200).json({
      pickup_pincode,
      to_pincode,
      tat_original: tatRaw,
      tat_days: tatDays,
      buffer_days: 1,
      final_days: finalDays,
      edd: edd.toISOString().split("T")[0]
    });

  } catch (e) {
    return res.status(500).json({ error: e.message });
  }
}
